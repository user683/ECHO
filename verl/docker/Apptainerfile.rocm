Bootstrap: docker

# Support - Traing: fsdp; Inference: vllm
# Support - Traing: fsdp; Inference: vllm, sglang

%environment
    export PYTORCH_ROCM_ARCH="gfx90a;gfx942"

    export HIPCC_COMPILE_FLAGS_APPEND="--amdgpu-target=gfx90a;gfx942 -D__HIP_PLATFORM_AMD__"
    export CFLAGS="-D__HIP_PLATFORM_AMD__"
    export CXXFLAGS="-D__HIP_PLATFORM_AMD__"

%post
    # Create source directory
    mkdir -p /opt/src

    # Uninstall and reinstall vllm
    pip uninstall -y vllm
    cd /opt/src
    cd vllm
    MAX_JOBS=$(nproc) python3 setup.py install
    cd /opt
    rm -rf /opt/src/vllm

    # Install dependencies
    pip install "tensordict<0.6" --no-deps
    pip install accelerate \
        codetiming \
        datasets \
        dill \
        hydra-core \
        liger-kernel \
        numpy \
        pandas \
        peft \
        "pyarrow>=15.0.0" \
        pylatexenc \
        "ray[data,train,tune,serve]" \
        torchdata \
        transformers \
        orjson \
        pybind11

    cd /opt
    cd verl
    # Uncomment to use a specific version
    # git checkout v0.3.0.post0
    pip install -e . --no-deps

    # Install torch_memory_saver